<!DOCTYPE html>
<html lang="zh">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
	<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-touch-fullscreen" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<link rel="stylesheet" type="text/css" href="../../css/materialdesignicons.min.css">
	<link rel="stylesheet" type="text/css" href="../../css/bootstrap.min.css">
	<!--表格插件css-->
	<link rel="stylesheet" href="../../js/bootstrap-table/bootstrap-table.min.css">
	<link rel="stylesheet" type="text/css" href="../../css/style.min.css">
	<link rel="stylesheet" type="text/css" href="../../css/jstree/style.min.css">

</head>

<body>
	<div class="container-fluid">
		<div class="card">
			<div class="row">
				<div class="col-md-3">
					<header class="card-header">
						<div class="card-title">组织机构</div>
					</header>
					<div class="card-body">
						<div id="drag-drop-tree"></div>
					</div>
				</div>
				<div class="col-md-9">
					<div class="card-body">
						<form class="search-form" method="get" action="#!" role="form">
							<div class="row">
								<div class="col-md-4">
									<div class="row">
										<label class="col-sm-4 col-form-label">
											用户名称</label>
										<div class="col-sm-8">
											<input type="text" class="form-control pull-left" id="username"
												name="username" value="" placeholder="请输入用户名称" />
										</div>
									</div>
								</div>
								<div class="col-md-4">
									<div class="row">
										<label class="col-sm-4 col-form-label">
											手机号</label>
										<div class="col-sm-8">
											<input type="text" class="form-control pull-left" id="phone" name="phone"
												value="" placeholder="请输入手机号" />
										</div>
									</div>
								</div>
								<!-- <input type="text" id="deptId" name="deptId" value="" /> -->
								<div class="col-md-4">
									<span class="btn btn-primary me-1" onclick="sousuo()">搜索</span>
									<button type="reset" class="btn btn-default">重置</button>
								</div>
							</div>
						</form>
						<div id="toolbar" class="toolbar-btn-action">
							<button id="btn_add" type="button" class="btn btn-primary me-1">
								<span class="mdi mdi-plus" aria-hidden="true"></span>新增
							</button>
							<button id="btn_delete" type="button" class="btn btn-danger">
								<span class="mdi mdi-window-close" aria-hidden="true"></span>删除
							</button>
						</div>
						<table id="table"></table>
					</div>
				</div>
			</div>

		</div>
	</div>
	</div>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script type="text/javascript" src="../../js/popper.min.js"></script>
	<script type="text/javascript" src="../../js/bootstrap.min.js"></script>
	<script type="text/javascript" src="../../js/main.min.js"></script>

	<!--表格插件js-->
	<script src="../../js/bootstrap-table/bootstrap-table.js"></script>
	<script src="../../js/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
	<script src="../../js/jstree/jstree.min.js"></script>

	<script src="../../js/globalConfig.js" type="text/javascript"></script>

	<script>
		(function () {
			$('#drag-drop-tree').jstree({
				'core': {
					'themes': {
						'responsive': false
					},
					'check_callback': true,
					'data': function (obj, callback) {
						$.ajax({
							url: baseUrl + "/admin/sys/dept/treeData",
							type: "GET",
							headers: { 'Authorization': token },
							success: function (data) {
								var arrays = data.data;
								var deptData = buildData(arrays);
								callback.call(this, deptData);

							},
							error: function (data) {
								responseError(data);
							}
						});
					}
				},
				'plugins': ['dnd', 'state']

			}).on('select_node.jstree', function (e, data) {
				deptId = data.node.id;
				var username = $("#username").val();
				var phone = $("#phone").val();
				loadTable(deptId, username, phone);
			})
			loadTable("");
		})();

		function sousuo() {
			var username = $("#username").val();
			var phone = $("#phone").val();
			loadTable(deptId, username, phone);
		}

		function loadTable(deptId, username, phone) {
			/**
			 * 用于演示的列信息
			 **/
			const columns = [{
				field: 'example',
				checkbox: true,
				// 列的宽度
				width: 5,
				// 宽度单位
				widthUnit: 'rem'
			}, {
				field: 'userName',
				align: 'center',
				title: '姓名',
				titleTooltip: '作者名称'
			}, {
				field: 'phone',
				align: 'center',
				title: '电话号',
			}, {
				field: 'loginName',
				// 是否可视(默认 - true)
				visible: false,
				align: 'center',
				title: '登录名'
			}, {
				field: 'email',
				align: 'center',
				title: '邮箱'
			}, {
				field: 'status',
				title: '状态',
				formatter: function (value, row, index) {
					var value = "";
					if (row.status == '0') {
						value = '<span class="badge bg-success">正常</span>';
					} else if (row.status == '1') {
						value = '<span class="badge bg-danger">禁用</span>';
					} else {
						value = '<span class="badge bg-secondary">未知</span>';
					}
					return value;
				}
			}, {
				field: 'operate',
				title: '操作',
				formatter: btnGroup,  // 自定义方法
				events: {
					'click .edit-btn': function (event, value, row, index) {
						event.stopPropagation();
						editUser(row);
					},
					'click .del-btn': function (event, value, row, index) {
						event.stopPropagation();
						delUser(row);
					}
				}
			}];
			$('#table').bootstrapTable('destroy');
			$('#table').bootstrapTable({
				classes: 'table table-hover',
				// 请求地址
				url: baseUrl + "/admin/sys/user/query/page",
				ajaxOptions: {
					headers: { "Authorization": token }
				},
				// 唯一ID字段
				uniqueId: 'id',
				// 每行的唯一标识字段
				idField: 'id',
				// 是否显示详细视图和列表视图的切换按钮(clickToSelect同时设置为true时点击会报错)
				showToggle: true,
				// 请求方法
				method: 'get',
				// 工具按钮容器
				toolbar: '#toolbar',
				// 是否分页
				pagination: true,
				// 分页方式：[client] 客户端分页，[server] 服务端分页
				sidePagination: "server",
				// 初始化加载第一页，默认第一页
				pageNumber: 1,
				// 每页的记录行数
				pageSize: 10,
				// 可供选择的每页的行数 - (亲测大于1000存在渲染问题)
				pageList: [5, 10, 25, 50, 100],
				// 在上百页的情况下体验较好 - 能够显示首尾页
				paginationLoop: true,
				// 展示首尾页的最小页数
				paginationPagesBySide: 2,
				// 展示首尾页的最小页数
				queryParams: function (params) {
					var temp = {
						size: params.limit,
						// sql语句起始索引
						// current: params.offset,
						current: (params.offset / params.limit) + 1,
						// 排序的列名
						sort: params.sort,
						deptId: deptId,
						phone: phone,
						username: username,
						// 排序方式 'asc' 'desc'
						sortOrder: params.order
					};
					return temp;
				},
				// 是否显示所有的列
				showColumns: true,
				// 是否显示刷新按钮
				showRefresh: true,
				// 显示图标
				showButtonIcons: true,
				// 显示文本
				showButtonText: false,
				// // 显示全屏
				// showFullscreen: true,
				// 开关控制分页
				showPaginationSwitch: true,
				// 总数字段
				totalField: 'total',
				// 当字段为 undefined 显示
				undefinedText: '-',
				// 排序方式
				sortOrder: "asc",
				// 图标前缀
				iconsPrefix: 'mdi',
				// 图标大小
				iconSize: 'mini',
				// 图标的设置
				icons: {
					paginationSwitchDown: 'mdi-door-closed',
					paginationSwitchUp: 'mdi-door-open',
					refresh: 'mdi-refresh',
					toggleOff: 'mdi-toggle-switch-off',
					toggleOn: 'mdi-toggle-switch',
					columns: 'mdi-table-column-remove',
					detailOpen: 'mdi-plus',
					detailClose: 'mdi-minus',
					fullscreen: 'mdi-monitor-screenshot',
					search: 'mdi-table-search',
					clearSearch: 'mdi-trash-can-outline'
				},
				// 按钮的类
				buttonsClass: 'default',
				// 类名前缀
				buttonsPrefix: 'btn',
				// 自定义的查询参数
				responseHandler: function (res) {
					return {
						"total": res.data.total,//总页数
						"rows": res.data.records //数据
					};
				},
				onLoadSuccess: function (data) {
				},

				columns,
				onLoadSuccess: function (data) {
					$("[data-bs-toggle='tooltip']").tooltip();
				}
			});

		}

		function buildData(data) {
			var str = [];
			$.each(data, function (index, domEle) {
				var subChildren = obtainSubChildren(domEle);
				var arr = {
					"id": domEle.id,
					"text": domEle.text,
					"children": subChildren,
					"icon": "mdi mdi-folder-outline",
					"state": { "selected": true, "opened": true }
				}
				str.push(arr);
			})
			return str;
		}
		function obtainSubChildren(domEle) {
			var str = [];
			if (domEle.children != '') {
				var subChildren2;
				$.each(domEle.children, function (index, subDomEle) {
					var arr = {
						"id": subDomEle.id,
						"text": subDomEle.text,
						"children": obtainSubChildren(subDomEle),
						"icon": "mdi mdi-folder-outline",
						"state": { "opened": true }
					}
					str.push(arr);
				})
			}
			return str
		}


		// 自定义操作按钮
		function btnGroup() {
			let html =
				'<a href="#!" class="btn btn-sm btn-default me-1 edit-btn" title="编辑" data-bs-toggle="tooltip"><i class="mdi mdi-pencil"></i></a>' +
				'<a href="#!" class="btn btn-sm btn-default del-btn" title="删除" data-bs-toggle="tooltip"><i class="mdi mdi-window-close"></i></a>';
			return html;
		}

		// 操作方法 - 编辑
		function editUser() {
			alert('跳转修改信息');
		}
		// 操作方法 - 删除
		function delUser() {
			alert('信息删除成功');
		}

	</script>

</body>

</html>